# Roguelike Dungeon — Adaptive Final v5

一款基于 **Pygame** 的复古像素风 *Roguelike 地牢游戏*，  
主打 **自适应难度**、**打击反馈完整**、**地牢自动生成 & 后台预生成下一关**。

---
- 游戏内容

<div style="display: flex; gap: 10px;">
<img alt="demo" src="https://github.com/user-attachments/assets/142ca4e6-8d5d-4835-a8d3-a7c69373a23e" style= "width:50%; max-width:400px;"/>

<img alt="2" src="https://github.com/user-attachments/assets/3e40e1cc-6b5e-43c8-9bed-8cefc34f4ec1" style="width:50%; max-width:400px;"/>
</div>

<img alt="gameover" src="https://github.com/user-attachments/assets/0b31b261-02f4-4718-ae82-cd80ee2535ef" style="width:50%; max-width:400px" />


---

## 🎮 游戏特色一览

### 1. 自适应难度系统（Difficulty Manager）

- 难度数值是 **实时动态调整** 的，并且在 HUD 上显示：
  - `Diff 1.00x ~ 12.00x`
- 难度只影响两件事：
  - **敌人数量**（越强越多）
  - **敌人移动速度**（有上限，避免过快）
- 调整依据玩家表现：
  - 通关耗时（越快代表越强）
  - 剩余血量 / 受到伤害
  - 本关获取的得分变化 `score_delta`
- **不会直接改动钥匙数量、武器数量等基础资源**，保持关卡节奏稳定  
- 右上角有一个常驻小面板显示：  
  `Difficulty: 1.23x`

---

### 2. 自动生成地牢 & 后台生成下一关

- 每一关地牢由随机数种子生成：
  - 房间（Room）随机尺寸 & 随机位置
  - 通过 **“最小生成树 + 额外随机连接”** 生成 **环状连通地图**
  - L 形走廊，宽度 1~3 格
- 当前关卡进行时：
  - **后台线程自动预生成下一关**
  - 进入门后可瞬时无缝切关
  - 如果后台太慢，会在主线程“兜底”生成，保证不会卡死
- 支持 **环绕地图（wrap world）**：
  - 超出屏幕边缘会从另一侧出现（无边界地图的感觉）

---

### 3. 安全出生区（Safe Zone）

- 玩家出生点周围有一个 **以格子数为单位的安全半径**：
  - 半径：`SAFE_RADIUS_TILES = 6`
- 在安全圈内：
  - 敌人不会生成
  - 敌人也不会进入
  - 离开安全区之后敌人 AI 才会真正激活
- 地图上用一圈淡色圆圈标记安全区范围，方便辨认

---

### 4. 打击反馈 & 视效完整恢复

本版本恢复并保留了所有视觉反馈效果：

- ✅ **地板格子背景 + 网格线**
- ✅ **受击闪红**（玩家被打时身体会变红）
- ✅ **击退效果（Knockback）**：
  - 敌人被攻击时会按方向被弹开一小段距离
  - 遇到墙壁或安全区会停止
- ✅ **粒子效果**：
  - 敌人死亡会溅射碎片式粒子
  - 攻击命中时的击飞粒子
- ✅ **圆形范围攻击特效（AOE 圆圈）**
- ✅ **屏幕震动（Screen Shake）**：
  - 玩家受伤时整体画面轻微抖动  
  - 强化打击感与危险感
- ✅ **死亡动画 & Game Over 界面**

---

### 5. 敌人类型 & 子弹系统

敌人有三种类型，行为各不相同：

1. **Chaser 追击型**
   - 高移动速度，直接向玩家追来
   - 接触玩家造成伤害

2. **Shooter 射手型**
   - 追击欲望较低，以射击为主
   - 会以玩家为目标发射子弹
   - 子弹会被墙阻挡

3. **Tank 肉盾型**
   - 体型更大，移动略慢
   - 接触伤害更高

其它战斗要素：

- 敌人子弹为独立实体：
  - 会检测与墙体碰撞（撞墙消失）
  - 会检测与玩家碰撞（命中扣血）
- 每种敌人死亡会增加不同分数：
  - `chaser`: 10 分
  - `shooter`: 12 分
  - `tank`: 20 分

---

### 6. 钥匙机制与门（Door）

- 门有两种状态：
  - 🔒 **Locked Door**（灰色）
  - 🔓 **Opened Door**（绿色）
- 每一关的钥匙数：
  - 固定为 **3~4 把**，但保证 **至少 2 把**
  - 钥匙位置通过离散算法分布，避免集中在一个角落
- 要求：
  - **必须收集完本关实际生成的所有钥匙**
  - `Keys: 当前钥匙数 / 本关需要数量`
  - 才会自动将门从 Locked 变为 Open
- 进入门格子 → 切换到下一关  
  通关后会额外获得 `SCORE_CLEAR = 50` 分奖励

---

### 7. 武器系统：近战 & 远程 AoE

地图上散落两种武器拾取物：

- 🟡 **Melee 近战武器**
  - 拾取后获得一定次数的近战圆形 AOE
  - 范围：`R_MELEE = 1.2 * TILE`
  - 伤害：命中范围内的敌人并击退
  - 适合贴脸清怪

- 🔵 **Ranged 远程武器**
  - 拾取后获得一定次数的远程大范围 AOE
  - 范围：`R_RANGED = 2.5 * TILE`
  - 覆盖面更广，但资源有限

使用方式：

- 共用一个攻击键：
  - **Space / 空格键**：释放当前可用的 AoE
  - 优先使用 Melee 次数，用完后再使用 Ranged
- 单次攻击冷却：`ATTACK_COOLDOWN = 0.5s`  
- 攻击命中会：
  - 造成伤害
  - 击退敌人
  - 生成粒子 & 屏幕震动

---

### 8. HUD & 信息展示

顶部 HUD 显示信息包括：

- `SCORE`：当前总分
- `HP`：当前血量 / 最大血量
- `Keys`：当前钥匙数 / 本关钥匙需求
- `Melee`：剩余近战 AOE 次数
- `Range`：剩余远程 AOE 次数
- `Lv`：当前关卡索引
- `AI`：当前 AI 激进度（与玩家状态相关）
- `Diff`：当前难度系数（自适应）
- `FPS`：帧率

额外提示文本：

- `Move: Arrows/WASD (wrap) | Attack: Space (Circle AoE; stacks) | Collect ALL green keys -> Door -> Next`

右上角单独固定一个难度面板：

- `Difficulty: 1.23x`  
- 带半透明深色背景突出显示，方便观察难度变化

---

## 操作说明

- **移动**
  - `WASD` 或 方向键（上下左右）
  - 超出边缘会从反方向出现（环绕地图）
- **攻击**
  - 空格键 `Space`：释放 AoE 攻击（优先近战，再远程）
- **退出游戏**
  - `Esc`：退出

---

## 技术要点

- 使用 **Pygame** 实现：
  - 自定义地牢生成算法（房间 + 走廊 + BFS 检测可达区域）
  - 游戏主循环 / 输入 / 绘制 / 碰撞检测
- 使用多线程：
  - `GenWorker` 负责 **后台生成下一关 Level**
- 使用简单的资源管理器：
  - `ResourceManager`（便于未来扩展纹理、音效等）

---

## 运行方式（示例）

```bash
python main.py
